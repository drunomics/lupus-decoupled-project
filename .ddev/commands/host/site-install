#!/bin/bash

## Description: Install Drupal site with lupus decoupled recipe
## Usage: site-install
## Aliases: si

set -e

echo "Installing PHP dependencies..."
ddev composer install

# Install additional composer packages if specified
if [[ -n "$ADDITIONAL_COMPOSER_PACKAGES" ]]; then
  echo "Installing additional packages: $ADDITIONAL_COMPOSER_PACKAGES"
  ddev composer require $ADDITIONAL_COMPOSER_PACKAGES
fi

echo "Installing Drupal with Lupus Decoupled Standard recipe..."
RECIPE=${RECIPE:-../recipes/lupus_decoupled_recipe/standard}
ddev drush si -y --site-name='lupus decoupled' "$RECIPE"

echo "Enabling services_env_parameter..."
ddev drush en services_env_parameter -y

echo "Setting admin password to: lupus123"
ddev drush user:password admin lupus123

echo "Configuring frontend URL..."
ddev drush config:set lupus_decoupled_ce_api.settings frontend_base_url "${FRONTEND_URL:-https://lupus-nuxt.ddev.site}" -y

# Set preview provider to "nuxt" (default for Nuxt frontends)
if [[ "${FRONTEND_REPOSITORY}" == *"nuxt"* ]] || [[ -z "${FRONTEND_REPOSITORY}" ]]; then
  echo "Setting preview provider to nuxt..."
  ddev drush config:set lupus_decoupled_ce_api.settings preview_provider "nuxt" -y
fi

echo ""
echo "Site installation complete!"
